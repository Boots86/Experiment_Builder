const gameTableHTML=document.getElementById("game-table"),modeSelect=document.getElementById("mode-setting"),newCellClassName="new-cell",cellIDName="game-cell-id-",flagClassName="cell-flag",setupGame=()=>{CONFIG.currentMode=modeSelect.value;const e=getCurrentGameMode(),t=e.bombs,l=e.size,a=l.rows,n=l.cols,m=[];let r,o,s,i,b,c,d,g,u,I=1e4;for(;m.length<t&&I>0;)r=Math.floor(Math.random()*(a*n))+1,-1===m.indexOf(r)&&m.push(r),I--;for(CONFIG.bombLocations=m,gameTableHTML.innerHTML="",o=0;o<a;o++)for(i=gameTableHTML.insertRow(o),s=1;s<=n;s++)(b=i.insertCell(s-1)).classList.add("new-cell"),b.setAttribute("row",o),b.setAttribute("col",s),c=makeCellID(o,s),b.id=cellIDName+c,u="",m.indexOf(c)>-1?(u="x",b.setAttribute("hasBomb",1)):(d=0,getCellIDsAround(o,s).map(e=>{m.indexOf(e)>-1&&d++}),d&&(u=d),b.setAttribute("bombsAroundCell",d)),(g=document.createElement("span")).classList.add("cell-content"),g.innerHTML=u,b.appendChild(g);CONFIG.gamePlayable=!0,setBombsRemaining(),timerControl("start")},getCellIDsAround=(e,t)=>{const l=getCurrentGameMode(),a=l.size.rows,n=l.size.cols,m=e+2,r=t+2,o=[];let s,i,b;for(s=e-1;s<m;s++)for(i=t-1;i<r;i++)b=makeCellID(s,i),s>=0&&s<a&&i>0&&i<=n&&makeCellID(e,t)!==b&&o.push(b);return o},makeCellID=(e,t)=>{return e*getCurrentGameMode().size.cols+t},getCurrentGameMode=()=>CONFIG.mode[CONFIG.currentMode],newCellClicked=(e,t)=>{const l=parseInt(e.getAttribute("row"),10),a=parseInt(e.getAttribute("col"),10),n=1===parseInt(e.getAttribute("hasBomb"),10),m=parseInt(e.getAttribute("bombsAroundCell"),10);if(!0===t){const t=1===parseInt(e.getAttribute("markedAsBomb"),10);if(e.setAttribute("markedAsBomb",t?0:1),t){const t=e.getElementsByClassName("cell-flag");e.removeChild(t[0])}else{const t=document.createElement("IMG");t.setAttribute("src","images/flag.png"),t.setAttribute("width","100%"),t.setAttribute("height","100%"),t.setAttribute("alt","Flag"),t.classList.add("cell-flag"),e.appendChild(t),e.setAttribute("hasFlag",1)}setBombsRemaining()}else{if(n)return timerControl(),alert("dead"),CONFIG.bombLocations.map(t=>{e=document.getElementById(cellIDName+t),bombImage=document.createElement("IMG"),bombImage.setAttribute("src","images/bomb.png"),bombImage.setAttribute("width","100%"),bombImage.setAttribute("height","100%"),bombImage.setAttribute("alt","Bomb"),bombImage.classList.add("cell-flag"),e.innerHTML="",e.appendChild(bombImage),e.setAttribute("hasFlag",0)}),void(CONFIG.gamePlayable=!1);e.classList.remove("new-cell"),0===m&&getCellIDsAround(l,a).map(e=>{let t;(t=document.getElementById(cellIDName+e))&&t.matches(".new-cell")&&1!==parseInt(t.getAttribute("hasFlag"),10)&&newCellClicked(t)})}const r=CONFIG.bombLocations,o=currentMarkedBombs();if(r.length===o.length){let e=0;o.map(t=>{r.indexOf(t)>-1&&e++}),e===r.length&&(alert("Game Won"),timerControl(),CONFIG.gamePlayable=!1)}},currentMarkedBombs=()=>{const e=gameTableHTML.getElementsByClassName("cell-flag"),t=e.length;let l,a,n=[];for(l=0;l<t;l++)a=e[l].parentNode,n.push(makeCellID(parseInt(a.getAttribute("row"),10),parseInt(a.getAttribute("col"),10)));return n},setBombsRemaining=()=>{document.getElementById("game-bombs-remaining").innerHTML=CONFIG.bombLocations.length-currentMarkedBombs().length},timerHTML=document.getElementById("game-timer");let timerInterval,timerTime=0;const timerControl=e=>{clearInterval(timerInterval),"start"===e&&(timerTime=0,timerInterval=setInterval(()=>{timerTime++,timerHTML.innerHTML=timerTime},1e3))};(()=>{let e;Object.keys(CONFIG.mode).forEach(t=>{(e=document.createElement("option")).value=t,e.text=CONFIG.mode[t].name,modeSelect.add(e)}),setupGame(),gameTableHTML.onmousedown=(e=>{if(e=e||window.event,!CONFIG.gamePlayable)return;let t,l,a=e.target;"which"in e?t=3===e.which:"button"in e&&(t=2===e.button),(l=a.matches(".cell-flag")&&t)&&(a=a.parentNode),(a.matches(".new-cell")||l)&&newCellClicked(a,t),gameTableHTML.oncontextmenu=(()=>!1)})})();